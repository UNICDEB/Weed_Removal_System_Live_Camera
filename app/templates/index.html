<!DOCTYPE html>
<html>

<head>
    <title>Weed AI Industrial Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f4f6f9;
        }

        .card {
            border-radius: 12px;
            border: none;
        }

        .log-box {
            height: 220px;
            overflow-y: auto;
            background: #ffffff;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            font-size: 14px;
        }

        .video-box {
            border-radius: 10px;
            border: 1px solid #dee2e6;
            background: #000;
        }

        .status-online {
            color: green;
            font-weight: bold;
        }

        .status-offline {
            color: red;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="container py-4">

        <div class="text-center mb-4">
            <h3 class="fw-bold text-dark">üåø Weed Detection AI Dashboard</h3>
            <p class="text-muted">Real-Time RGB + Depth Coordinate Monitoring</p>
        </div>

        <div class="row">

            <!-- LEFT PANEL -->
            <div class="col-md-4">

                <!-- Control Panel -->
                <div class="card shadow-sm p-4 mb-3">
                    <h5 class="mb-3 text-dark">‚öô Control Panel</h5>

                    <label class="form-label">Confidence Threshold</label>

                    <input type="range" class="form-range" min="0" max="1" step="0.01" value="0.5" id="confSlider"
                        oninput="updateConfidenceValue(this.value)">

                    <input type="number" class="form-control mb-3" min="0" max="1" step="0.01" value="0.5"
                        id="confInput" oninput="syncSlider(this.value)">

                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="startCamera()">‚ñ∂ Open Camera</button>
                        <button class="btn btn-warning" onclick="stopCamera()">‚èπ Stop Camera</button>
                        <button class="btn btn-danger" onclick="exitSystem()">‚ùå Exit System</button>
                        <button id="zoneBtn" class="btn btn-primary" onclick="toggleZone()">
                            Enable Zone Mode
                        </button>
                    </div>
                </div>

                <!-- Target Selection -->
                <div class="card shadow-sm p-3 mb-3">
                    <h6>üì° Target Selection</h6>

                    <select id="targetSelect" class="form-select" onchange="setTarget(this.value)">
                        <option value="rpi">RPI</option>
                        <option value="arduino">Arduino</option>
                    </select>

                    <p class="mt-2">Arduino:
                        <span id="arduinoStatus" class="status-offline">Disconnected</span>
                    </p>

                    <p>RPI:
                        <span id="rpiStatus" class="status-offline">Disconnected</span>
                    </p>
                </div>

                <!-- System Info -->
                <div class="card shadow-sm p-3 mb-3">
                    <h6>üñ• System Info</h6>
                    <p>Device:
                        <span id="device" class="fw-bold text-primary">-</span>
                    </p>

                    <p>Active Receiver:
                        <span id="receiverStatus" class="fw-bold">-</span>
                    </p>

                    <p>Total Detections:
                        <span id="count" class="fw-bold text-success">0</span>
                    </p>
                    <p>Weeder Position:
                        <span id="weederState" class="fw-bold">-</span>
                    </p>
                </div>

                <!-- Latest Coordinate -->
                <div class="card shadow-sm p-3 mb-3">
                    <h6>üìç Latest Coordinate (cm)</h6>
                    <p id="latestCoord" class="fw-bold text-secondary">
                        No detection yet
                    </p>
                </div>

                <!-- System Control -->
                <div class="card shadow-sm p-3">
                    <h6>üéÆ System Control</h6>

                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="sendCommand('xF')">‚ñ∂ Start</button>
                        <button class="btn btn-danger" onclick="sendCommand('xS')">‚ñ† Stop</button>
                        <button class="btn btn-primary" onclick="sendCommand('xH')">‚¨Ü Speed Up</button>
                        <button class="btn btn-secondary" onclick="sendCommand('xL')">‚¨á Speed Down</button>
                    </div>

                    <p class="mt-2">Arduino Feedback:
                        <span id="arduinoFeedback">-</span>
                    </p>

                    <hr>

                    <h6>üõ† Manual Weeder Control</h6>

                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-success" onclick="weederUp()">
                            ‚¨Ü Weeder UP
                        </button>
                        <button class="btn btn-outline-danger" onclick="weederDown()">
                            ‚¨á Weeder DOWN
                        </button>
                    </div>

                    <p class="mt-2 fw-bold" id="weederMsg"></p>
                </div>

                <button class="btn btn-dark" onclick="openValueWindow()">
                    üìù Value Input
                </button>

            </div>

            <!-- RIGHT PANEL -->
            <div class="col-md-8">

                <div class="card shadow-sm p-3 mb-3">
                    <h5>üì∑ Live RGB Stream</h5>
                    <div class="video-box">
                        <img id="video" width="100%" class="img-fluid rounded">
                    </div>
                </div>

                <div class="card shadow-sm p-3">
                    <h6>üìú Detection Log</h6>
                    <div class="log-box" id="logBox"></div>
                </div>

            </div>

        </div>

    </div>

    <script>

        function updateConfidenceValue(val) {
            document.getElementById("confInput").value = val;
        }

        function syncSlider(val) {
            document.getElementById("confSlider").value = val;
        }

        function startCamera() {
            let conf = document.getElementById("confInput").value;

            fetch("/start?conf=" + conf, { method: "POST" })
                .then(() => {
                    document.getElementById("video").src = "/video";
                });
        }

        function stopCamera() {
            fetch("/stop", { method: "POST" })
                .then(() => {
                    document.getElementById("video").src = "";
                });
        }

        function exitSystem() {
            fetch("/exit", { method: "POST" });
        }

        function setTarget(mode) {
            fetch("/set_target?mode=" + mode, { method: "POST" });
        }

        function sendCommand(cmd) {
            fetch("/arduino_command?cmd=" + cmd, { method: "POST" })
                .then(res => res.json())
                .then(data => {
                    document.getElementById("arduinoFeedback").innerText =
                        "Sent: " + data.sent + " | Feedback: " + data.feedback;
                });
        }

        function toggleZone() {
            fetch("/toggle_zone", { method: "POST" })
                .then(res => res.json())
                .then(data => {
                    let btn = document.getElementById("zoneBtn");
                    if (data.zone) {
                        btn.innerText = "Disable Zone Mode";
                        btn.className = "btn btn-secondary";
                    } else {
                        btn.innerText = "Enable Zone Mode";
                        btn.className = "btn btn-primary";
                    }
                });
        }

        function updateStatus() {
            fetch("/status")
                .then(res => res.json())
                .then(data => {

                    // =========================
                    // BASIC SYSTEM INFO
                    // =========================
                    document.getElementById("device").innerText =
                        data.device || "-";

                    document.getElementById("receiverStatus").innerText =
                        data.receiver || "-";

                    document.getElementById("count").innerText =
                        data.detection_count ?? 0;

                    // =========================
                    // WEEDER POSITION
                    // =========================
                    let weederState = document.getElementById("weederState");
                    weederState.innerText = data.weeder_position || "-";

                    // Color indication
                    if (data.weeder_position === "UP") {
                        weederState.style.color = "green";
                    } else if (data.weeder_position === "DOWN") {
                        weederState.style.color = "red";
                    } else {
                        weederState.style.color = "gray";
                    }

                    // =========================
                    // TARGET MODE SYNC
                    // =========================
                    document.getElementById("targetSelect").value =
                        data.target || "rpi";

                    // =========================
                    // ARDUINO STATUS
                    // =========================
                    let aStatus = document.getElementById("arduinoStatus");
                    if (data.arduino_connected) {
                        aStatus.innerText = "Connected";
                        aStatus.className = "status-online";
                    } else {
                        aStatus.innerText = "Disconnected";
                        aStatus.className = "status-offline";
                    }

                    // =========================
                    // RPI STATUS
                    // =========================
                    let rStatus = document.getElementById("rpiStatus");
                    if (data.rpi_connected) {
                        rStatus.innerText = "Connected";
                        rStatus.className = "status-online";
                    } else {
                        rStatus.innerText = "Disconnected";
                        rStatus.className = "status-offline";
                    }

                    // =========================
                    // LATEST COORDINATE
                    // =========================
                    if (data.latest) {
                        document.getElementById("latestCoord").innerText =
                            `Start_Z: ${data.latest["Start_Z(m)"]} m | ` +
                            `End_Z: ${data.latest["End_Z(m)"]} m | ` +
                            `${data.latest.CMD_UP} | ${data.latest.CMD_DOWN}`;
                    } else {
                        document.getElementById("latestCoord").innerText =
                            "No detection yet";
                    }

                    // =========================
                    // LOG DISPLAY
                    // =========================
                    let logBox = document.getElementById("logBox");
                    logBox.innerHTML = "";

                    if (Array.isArray(data.log)) {
                        data.log.forEach(item => {
                            logBox.innerHTML +=
                                `Start_Z: ${item["Start_Z(m)"]} m | ` +
                                `End_Z: ${item["End_Z(m)"]} m | ` +
                                `${item.CMD_UP} | ${item.CMD_DOWN}<br>`;
                        });
                    }

                    logBox.scrollTop = logBox.scrollHeight;
                })
                .catch(err => {
                    console.error("Status update failed:", err);
                });
        }

        function openValueWindow() {
            window.open(
                "/value_input",
                "ValueInput",
                "width=500,height=600,resizable=no"
            );
        }

        function weederUp() {
            fetch("/weeder/up", { method: "POST" })
                .then(res => res.json())
                .then(data => {
                    document.getElementById("weederMsg").innerText = data.msg;
                    document.getElementById("weederMsg").style.color =
                        (data.status === "ok") ? "green" : "orange";
                });
        }

        function weederDown() {
            fetch("/weeder/down", { method: "POST" })
                .then(res => res.json())
                .then(data => {
                    document.getElementById("weederMsg").innerText = data.msg;
                    document.getElementById("weederMsg").style.color =
                        (data.status === "ok") ? "green" : "orange";
                });
        }


        setInterval(updateStatus, 500);

    </script>

</body>

</html>